var form_submitted = false;
var newqnuniqid = 10000000000;
var QuizFactory = {};

(function($){
	QuizFactory.init_global = function(){
		$('.btn-subscribe, .btn-unsubscribe').click(function(){
			var button = $(this);
			if(button.find('i').length > 0){
				button.find('i').removeClass().addClass('btn-progress');
			} else {
				button.addClass('btn-progress');
			}
			
			$.ajax({
				url: button.attr('href'),
				dataType: 'json',
				success: function(data) {
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').find('.modal-body').html(data.error);
						$('#message-modal').modal('show');
					}
					button.remove();
				}
			});
		});
		
		$('body').on('mouseover', '.tooltip-hover', function(){$(this).tooltip('show');});
		$(document.body).append($('<div>', {'id': 'cj-wrapper'}).append($('#cj-wrapper').find('.modal')));
		
		$('#cj-wrapper').find('.quiz-form').find('[data-toggle="tab"]').click(function(){
			$(this).tab('show');
			return false;
		});
		
		$('#quiz-questions').on('click', '[data-toggle="panel-collapse"]', function(){
			var my = $(this);
			var mybody = my.closest('.panel').find('.panel-body');
			
			if(mybody.is(':hidden')){
				mybody.removeClass('hide').slideDown();
				my.closest('.panel-container').find('.panel-body').not(mybody).slideUp();
			} else {
				mybody.slideUp();
			}
		});
	};
	
	QuizFactory.init_quiz_list = function(){
		$('.star-rating').raty({
			path: cjlib_loc+'/jquery/images',
			round : { down: .25, full: .6, up: .76 },
			score: function() { return $(this).attr('data-rating-score');},
			halfShow: true,
			readOnly: true,
			noRatedMsg: $('#data-rating-noratemsg').text(),
			hints: $('#data-rating-hints').text().split(',')
		}).removeAttr('title').find('img').tooltip();
	};
	
	QuizFactory.init_create_edit_quiz = function(){
		$('#quiz-form').validate();
		
		$('.quiz-tags').on('click', '.btn-remove-tag', function(){
			$(this).closest('li').hide('slow', function(){ $(this).closest('li').remove(); });
		});
		
		$('.btn-submit-form').click(function(){
			var tags = new Array();
			$('.quiz-tags').find('.tag-item').each(function(){
				tags.push($(this).text());
			});
			$('.quiz-tags').find('input[name="tags"]').val(tags.join(','));
			$('.quiz-form').submit();
		});
		
		$('#input-tags').typeahead({
			minLength: 1,
			menu: '<ul class="typeahead dropdown-menu"></ul>',
			item: '<li><a href="#"></a></li>',
			source: function (query, process) {
				$.getJSON($('#url-get-tags').text(), { search: query }, function (data) {
					results = new Array();
					$.each(data.tags, function (i, tag) {
						var found = false;
						$('.quiz-tags').find('.tag-item').each(function(){
							if(tag.tag_text.toLowerCase() == $(this).text().toLowerCase()){
								found  = true;
								return false;
							}
						});
						if(!found) {
							if(null != tag.description){
								results.push('<li><div class="tag-value">'+tag.tag_text+'</div><div>'+tag.description.substring(0, 100)+'...</div></li>');
							}else{
								results.push('<li><div class="tag-value">'+tag.tag_text+'</div></li>');
							}
						}
					});
					process(results);
				});
			},
			highlighter: function (item) {
			    var regex = new RegExp( '(' + this.query + ')', 'gi' );
			    var value = $('<div>').html(item).find('.tag-value').html().replace(regex, "<strong>$1</strong>");
			    var rtn = $('<div>', {'class': 'dummy'}).html(item);
			    rtn.find('.tag-value').html(value);
			    
			    return rtn.html();
			},
			updater: function (item) {
				var found = false;
				var value = $('<div>').html(item).find('.tag-value').text();
				$('.quiz-tags').find('.tag-item').each(function(){
					if(value.toLowerCase() == $(this).text().toLowerCase()){
						found  = true;
						return false;
					}
				});
				
				if(!found){
					$('.quiz-tags').find('ul').append(
						$('<li>', {'id': 0, 'class': 'label'}).append(
							$('<a>', {'class': 'btn-remove-tag', 'href': '#', 'onclick': 'return false'}).append($('<i>', {'class': 'icon-remove icon-white'})),
							'&nbsp;',
							$('<span>', {'class': 'tag-item'}).append(value)
						));
					$('#input-tags').val('');
				}
				
				return '';
			}
		});
		
		$('#input-tags').keypress(function(e){
			if ( e.which == 13 || e.which == 59 || e.which == 44){
				e.preventDefault();
				var found = false;
				var value = $.trim($('#input-tags').val());
				
				if(value == '' || value.length < 2) return false;
				
				$('.quiz-tags').find('.tag-item').each(function(){
					if(value.toLowerCase() == $(this).text().toLowerCase()){
						found  = true;
						return false;
					}
				});
				
				if(!found){
					$('.quiz-tags').find('ul').append(
						$('<li>', {'id': 0, 'class': 'label'}).append(
							$('<a>', {'class': 'btn-remove-tag', 'href': '#', 'onclick': 'return false'}).append($('<i>', {'class': 'icon-remove icon-white'})),
							'&nbsp;',
							$('<span>', {'class': 'tag-item'}).append(value)
						));
					$('#input-tags').val('');
				}
			}
		});
	};
	
	QuizFactory.init_form = function(){
		QuizFactory.make_answers_sortable();
		
		$('#qntype-header').click(function(){QuizFactory.create_new_question(1);});
		$('#qntype-radio').click(function(){QuizFactory.create_new_question(2);});
		$('#qntype-checkbox').click(function(){QuizFactory.create_new_question(3);});
		$('#qntype-select').click(function(){QuizFactory.create_new_question(4);});
		$('#qntype-grid-radio').click(function(){QuizFactory.create_new_question(5);});
		$('#qntype-grid-checkbox').click(function(){QuizFactory.create_new_question(6);});
		$('#qntype-singleline').click(function(){QuizFactory.create_new_question(7);});
		$('#qntype-multiline').click(function(){QuizFactory.create_new_question(8);});
		$('#qntype-password').click(function(){QuizFactory.create_new_question(9);});
		$('#qntype-richtext').click(function(){QuizFactory.create_new_question(10);});
		$('#qntype-image').click(function(){QuizFactory.create_new_question(11);});
		$('#qntype-images').click(function(){QuizFactory.create_new_question(12);});
		
		$('#quiz-questions').on('sortupdate', function(event, ui) {
			if(ui.item.hasClass('question-item')){
				
				var positions = new Array();
				
				$('.quiz-form').find('.question-item').each(function(index){
					positions.push((index + 1) + '_' + $(this).find('input[name="qid"]').val());
				});
				
				$.ajax({
					url: $('#url_update_ordering').text(),
					data: {'ordering': positions, 'pid': $('#page_id').val()},
					type: 'post',
					success: function(data, statusText, xhr, form){
						if(typeof data.error != 'undefined' && data.error.length > 0){
							$('#message-modal').modal('show').find('.modal-body').html(data.error);
						}
					}
				});				
			}
		});
		
		$('#quiz-questions').on('click', '.btn-submit-form', function(){
			var button = $(this);
			var form = button.closest('.question-form');
			var qtype = form.find('input[name="qtype"]').val();
			var answers = new Array();
			var columns = new Array();
			var order = 1;
			var image = '';
			
			form.find('.answers').find('.answer-item').each(function(index)
			{
				answer = $(this).find('.input-answer');
				marks = $(this).find('.input-marks').val();
				image = $(this).find('input[name="image-src"]').val();
				
				if($.trim(answer.val()).length > 0)
				{
					if(answer.attr('name').indexOf('-') == 6)
					{
						id = answer.attr('name').substring(7);
					} 
					else 
					{
						id = 0;
					}
					
					correct_answer = 0;
					
					if(qtype == 2 || qtype == 3 || qtype == 4 || qtype == 11 || qtype == 12)
					{
						if($(this).find('.correct-answer').is(':checked'))
						{
							correct_answer = 1;
						}
					} 
					else if(qtype == 5 || qtype == 6)
					{
						correct_answer = $(this).find('.correct-answer').val();
					}
					
					answers.push(id+'_'+order+'_'+correct_answer+'_'+marks+'_'+image+'_'+answer.val());
					order++;
				}
			});
			
			if(qtype == 5 || qtype == 6)
			{
				order = 1;
				form.find('.columns').find('.answer-item').each(function(index)
				{
					answer = $(this).find('.input-answer');
					if($.trim(answer.val()).length > 0)
					{
						if(answer.attr('name').indexOf('-') == 6)
						{
							id = answer.attr('name').substring(7);
						} 
						else 
						{
							id = 0;
						}
						columns.push(id+'_'+order+'_0_0_'+'_'+answer.val());
						order++;
					}
				});				
			}
			
			QuizFactory.refresh_editor();
			
			form.ajaxSubmit({
				dataType:  'json',
				data: {'pid': $('#page_id').val(), 'answers': answers, 'columns': columns, 'order': $('.question-item').index(form.closest('.question-item')) + 1},
				beforeSubmit: function(arr, objform, options) {
					if(form.valid()){
						button.button('loading');
					} else {
						return false;
					}
				},
				success: function(data){
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').modal('show').find('.modal-body').html(data.error);
					} else {
						var answers = new Array();
						var columns = new Array();
						
						$.each(data.question.answers, function(key, answer){
							if(answer.answer_type == 'x'){
								answers.push(answer);
							}else if(answer.answer_type == 'y'){
								columns.push(answer);
							}
						});
						
						form.find('.answers').find('.input-answer').each(function(index){
							if(index < answers.length){
								$(this).val(answers[index].title);
								$(this).attr('name', 'answer-'+answers[index].id);									
							}
						});
						
						if(qtype == 5 || qtype == 6){
							form.find('.columns').find('.input-answer').each(function(index){
								if(index < columns.length){
									$(this).val(columns[index].title);
									$(this).attr('name', 'answer-'+columns[index].id);									
								}
							});
							
							form.find('.answers').find('.input-answer').each(function(index){
								var toggle = $(this).closest('.answer-item').find('.correct-answer');
								toggle.find('option').not('[value=""]').remove();
								var my_id = $(this).attr('name').substring($(this).attr('name').indexOf('-')+1);
								try{my_id = parseInt(my_id);}catch(e){}
								
								$.each(columns, function(key, column){
									var correct = false;
									$.each(answers, function(k, a){
										if(a.id == my_id && a.correct_answer == column.id){
											correct = true;
										}
									});
									
									toggle.append($('<option>', {'value': column.id, 'selected': correct}).html(column.title));
								});
							});
						}
						
						var question_item = button.closest('.question-item');
						form.find('input[name="title"]').val(data.question.title);
						question_item.find('.qn-title').html(data.question.title);
						
						if(form.find('input[name="qid"]').val() == 0){
							form.find('input[name="qid"]').val(data.question.id);
							question_item.find('[href$="-qid"]').each(function(){
								var value = $(this).attr('href');
								value = value.substring(0, value.indexOf('-')+1);
								$(this).attr('href', value+data.question.id);
							});
							question_item.find('[id$="-qid"]').each(function(){
								var value = $(this).attr('id');
								value = value.substring(0, value.indexOf('-')+1);
								$(this).attr('id', value+data.question.id);
							});
							question_item.find('[name$="-qid"]').each(function(){
								var value = $(this).attr('name');
								value = value.substring(0, value.indexOf('-')+1);
								$(this).attr('name', value+data.question.id);
							});
							question_item.find('[id$="-qid0"]').each(function(){
								var value = $(this).attr('id');
								value = value.substring(0, value.indexOf('-')+1);
								$(this).attr('id', value+data.question.id);
							});
							QuizFactory.attach_editor(form.find('#desc-'+data.question.id));
							QuizFactory.attach_editor(form.find('#explanation-'+data.question.id));
							
							$('html,body').animate({scrollTop: question_item.offset().top},'slow');
						}
						
						question_item.find('[data-toggle="panel-collapse"]').click();
					}
					button.button('reset');
				}
			});
		});
		
		// file upload button function
		var upload_button = null;
		$('#quiz-questions').on('click', '.btn-change-image', function(){
			upload_button = $(this);
			$('.input-file-upload').click();
        });
		
		$('.input-file-upload').change(function(){
			button = upload_button;
			button.find('i').addClass('btn-progress').removeClass('icon-picture');
			$('.file-upload-error').hide().find('.error-msg').html('');
			
			$('#file-upload-form').ajaxSubmit({
				dataType : 'json',
				success: function(data, status, xhr, $form) {
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('.file-upload-error').show().find('.error-msg').html(data.error);
					}else{
						button.closest('.img-answer-wrapper').find('.img-answer').attr('src', data.url);
						button.closest('.img-answer-wrapper').find('input[name="image-src"]').val(data.file_name);
					}
					button.find('i:first').addClass('icon-picture').removeClass('btn-progress');
				}
			});
		});
		// file upload button function
		
		$('#quiz-questions').on('click', '.btn-delete-question', function(){
			var button = $(this);
			var qid = button.closest('.question-item').find('input[name="qid"]').val();
			var uniq_id = button.closest('.question-item').find('input[name="uniq_id"]').val();
			var page_number = button.closest('.question-item').find('input[name="page_number"]').val();
			button.addClass('btn-progress').find('i').removeClass('icon-trash');
			try{qid = parseInt(qid);}catch(e){}
			
			$('#confirm-modal').modal('show').find('.btn-confirm').off().click(function(){
				if(qid > 0){
					var me = $(this).button('reset');
					me.button('loading');
					$.ajax({
						url: $('#url_delete_qn').text(),
						type: 'post',
						dataType: 'json',
						data: {'pid': $('#page_id').val(), 'qid': qid, 'uniq_id' : uniq_id, 'page_number' : page_number},
						success: function(data, status, xhr, form){
							if(typeof data.error != 'undefined' && data.error.length > 0){
								$('#message-modal').find('.modal-body').html(data.error);
								$('#message-modal').modal('show');
								$('#confirm-modal').modal('hide');
							} else {
								button.closest('.question-item').hide('slow', function(){ $(this).remove(); });
							}
							me.button('reset');
							button.removeClass('btn-progress').find('i').addClass('icon-trash');
							$('#confirm-modal').modal('hide');
						}
					});
				} else {
					button.closest('.question-item').hide('slow', function(){ $(this).remove(); });
					$('#confirm-modal').modal('hide');
				}
			});
			$('#confirm-modal').modal('show').find('.btn-cancel').off().click(function(){
				button.removeClass('btn-progress').find('i').addClass('icon-trash');
			});
			return false;
		});
		
		$('#quiz-questions').on('click', '.btn-move-question', function(){
			var button = $(this);
			$('#page-modal').modal('show');
			$('.btn-save-pid').click(function(){
				var me = $(this);
				me.button('loading');
				$.ajax({
					type: 'get',
					dataType: 'json',
					url: $('#url_move_page').text(),
					data: {'qid': button.closest('.question-item').find('input[name="qid"]').val(), 'uniq_id': button.closest('.question-item').find('input[name="uniq_id"]').val(), 'pid': $('#page-modal').find('select[name="pid"]').val()},
					success: function(data, status, xhr, form){
						$('#page-modal').modal('hide');
						if(typeof data.error != 'undefined' && data.error.length > 0){
							$('#message-modal').find('.modal-body').html(data.error);
							$('#message-modal').modal('show');
						}else{
							button.closest('.question-item').remove();
							me.button('reset');
						}
					}
				});
			});
			return false;
		});
		
		$('#quiz-questions').on('click', '.btn-add-answer', function(){
			var template = $('<div>', {'class': 'margin-bottom-10 form-inline answer-item clearfix'}).html($('#tpl-new-answer').html());
			var type = $(this).closest('.question-item').find('input[name="qtype"]').val();
			try{type = parseInt(type);}catch(e){type = 2;}
			
			if(type != 2 && type != 4 && type != 11){
				template.find('.correct-answer-radio').remove();
			}
			if(type != 3 && type != 12){
				template.find('.correct-answer-checkbox').remove();
			}
			if(type != 5 && type != 6){
				template.find('.correct-answer-select').remove();
			}
			if(type == 11 || type == 12){
				template.find('.input-answer-2').remove();
			} else {
				template.find('.img-answer-wrapper').remove();
			}
			template.insertBefore($(this));
		});
		
		$('#quiz-questions').on('click', '.btn-add-column', function(){
			var template = $('<div>', {'class': 'margin-bottom-10 form-inline answer-item'}).html($('#tpl-new-answer').html());
			template.find('.input-marks, .correct-answer-radio, .correct-answer-checkbox, .correct-answer-select, .img-answer-wrapper').remove();
			template.insertBefore($(this));
		});
		
		$('#quiz-questions').on('click', '.btn-delete-answer', function(){
			$(this).closest('.answer-item').remove();
		});
		
		$('#btn-remove-page').click(function(e){
			e.preventDefault();
			$('#remove-page-modal').modal('show').find('.btn-confirm').attr('href', $(this).attr('href')).click(function(){$(this).button('loading');});
		});
	};
	
	QuizFactory.make_answers_sortable = function(){
		$('.answers, .columns').sortable({revert: true, handle: '.btn-sort-answer', placeholder: 'well well-small', forcePlaceholderSize: true});
		$('#quiz-questions').sortable({revert: true, handle: '.btn-sort-question', placeholder: 'well well-small', forcePlaceholderSize: true});
	};
	
	QuizFactory.create_new_question = function(type){
		var template = $('<div>').append($('#tpl-question').html()).children(":first");
		
		if(type == 1){
			template.find('.blk-explanation, .blk-options').remove();
			template.find('.btn-sort-answer').attr('title', '').removeClass('btn-sort-answer').find('.icon-move').removeClass('icon-move').addClass('icon-screenshot');
		}
		
		if(type != 2 && type != 3 && type != 4 && type != 5 && type != 6 && type != 11 && type != 12){
			template.find('.blk-explanation, .answers, .nav-tabs').remove();
		}
		
		if(type != 2 && type != 3 && type != 4 && type != 5 && type != 6){
			template.find('.blk-custom-answer').remove();
		}
		
		if(type != 2 && type != 3 && type != 11 && type != 12){
			template.find('.blk-orientation').remove();
		}
		
		if(type != 5 && type != 6){
			template.find('.columns').remove();
		}
		
		if(type != 2 && type != 4 && type != 11){
			template.find('.correct-answer-radio').remove();
		}
		
		if(type != 3 && type != 12){
			template.find('.correct-answer-checkbox').remove();
		}
		
		if(type != 5 && type != 6){
			template.find('.correct-answer-select').remove();
		}
		
		if(type == 11 || type == 12){
			template.find('.input-answer-2').remove();
		} else {
			template.find('.img-answer-wrapper').remove();
		}
		
		switch (type) {
		case 1:
			template.find('.icon').addClass('fa fa-magnet');
			break;
		case 2:
			template.find('.icon').addClass('fa fa-dot-circle-o');
			break;
		case 3: 
			template.find('.icon').addClass('icon-check-square-o');
			break;
		case 4:
			template.find('.icon').addClass('fa fa-hand-o-up');
			break;
		case 5:
			template.find('.icon').addClass('fa fa-th-large');
			break;
		case 6: 
			template.find('.icon').addClass('fa fa-th-large');
			break;
		case 7:
			template.find('.icon').addClass('fa fa-minus');
			break;
		case 8:
			template.find('.icon').addClass('fa fa-align-justify');
			break;
		case 9:
			template.find('.icon').addClass('fa fa-qrcode');
			break;
		case 10:
			template.find('.icon').addClass('fa fa-file');
			break;
		case 11:
			template.find('.icon').addClass('fa fa-picture-o');
			break;
		case 12:
			template.find('.icon').addClass('fa fa-film');
			break;
		}
		
		template.find('input[name="qtype"]').val(type);
		
		if(type == 1){
			$('.quiz-form').prepend(template);
		} else {
			$('.quiz-form').append(template);
		}		
		template.find('.btn-submit-form').click();
	};
	
	QuizFactory.attach_editor = function(target){
		if(typeof cjbbcode != 'undefined'){
			target.markItUp(cjbbcode);
//		}else if(typeof WFEditor != 'undefined'){
//			WFEditor.create([target.attr('id')]);
		}else if(typeof tinyMCE != 'undefined'){
			tinyMCE.execCommand('mceAddControl', false, target.attr('id'));
		}
	};
	
	QuizFactory.refresh_editor = function(){
        if(typeof tinyMCE != 'undefined'){
        	tinyMCE.triggerSave(true,true);
        	tinyMCE.execCommand('mceRepaint');
        }
	};
	
	QuizFactory.init_quiz_response = function(){
		
    	$('#btn_submit').click(function(){
    		if(form_submitted == false){
        		if($('#response-form').valid()){
            		$('#txt_errors_alert').hide();
            		$('#response-form').submit();
            		$(this).button('loading');
            		form_submitted = true;
        		} else {
        			$('#txt_errors_alert').show();
        			return false;
        		}    			
    		}
    	});
		
		$('#btn-previous').click(function(){
			if(form_submitted == false){
        		if($('#response-form').valid()){
            		$('#txt_errors_alert').hide();
            		$('#response-form').attr('action', $('#url_previous_page').text());
            		$('#response-form').submit();
            		$(this).button('loading');
            		form_submitted = true;
        		} else {
        			$('#txt_errors_alert').show();
        			return false;
        		}    			
			}
		});
    	
		$('#response-form').validate({
			errorPlacement: function(error, element) {
				error.html($('#default_error_required').html());
				if(element.closest('.question-item').find('label.error').length == 0){
					error.insertAfter( element.closest('.question-item').find('.question-title') );
				}
			}
		});
		
		$('#cj-star-rating').raty({
			path: cjlib_loc+'/jquery/images',
			target: 'input[name="quiz-rating"]',
			targetType: 'number',
			targetKeep: true,
			halfShow: true,
			readOnly: false,
			noRatedMsg: $('#data-rating-noratemsg').text(),
			hints: $('#data-rating-hints').text().split(',')
		}).removeAttr('title').find('img').tooltip();
		
		var time_left = $('#time_left').text();
		var seconds = 0;
		try{
			seconds = parseInt(time_left);
		}catch(e){}
		
		if(seconds >= 0){
			
			QuizFactory.form_submitted = false;
			
			$('.quiz-timer').countdown({
				labels: $('#date_labels1').text().split(','),
				labels1: $('#date_labels2').text().split(','),
				until: '+'+seconds, 
				onTick: function(periods){					
					if ($.countdown.periodsToSeconds(periods) == 30) {
				        $(this).addClass('highlight'); 
				    }
				},
				onExpiry: function(){					
					if(QuizFactory.form_submitted == false){						
						$('#response-form').find("input[name='finalize']").val('1');
						$('#response-form')[0].submit();						
						QuizFactory.form_submitted = true;
					}
				}
			});
		}
	};
	
    QuizFactory.init_quiz_response1 = function(){
    	
    	$('.qn-page-header').parent().insertAfter($('#dummyelement'));
        
        var pctcompleted = 0;
        try{pctcompleted = parseInt($('.progress-status').val());}catch(e){}
        $('.response-progress-bar').progressbar({value: pctcompleted});
    	
    	$('#btn_submit').click(function(){
    		$('#response-form').attr('action', $(this).attr('href'));
    		$('#response-form').submit();
    	});
    	
		$('#response-form').validate({
			
			errorPlacement: function(error, element) {
				
				error.html($('#default_error_required').html());
				
				if(element.parents('.quiz-question').find('label.error').length == 0){
					
					error.insertAfter( element.parents('div.quiz-question').find('.question_title') );
				}
			}
		});
		
		var quiz_duration = $('#quiz_duration').text();
		var seconds = 0;
		try{
			seconds = parseInt(quiz_duration);
		}catch(e){}
		
		if(seconds >= 0){
			QuizFactory.form_submitted = false;
			$('.quiz-timer').countdown({
				labels: $('#date_labels1').text().split(','),
				labels1: $('#date_labels2').text().split(','),
				until: '+'+seconds, 
				onTick: function(periods){
					if ($.countdown.periodsToSeconds(periods) == 30) {
				        $(this).addClass('highlight'); 
				    }
				},
				onExpiry: function(){
					if(QuizFactory.form_submitted == false){
						$('#response-form').find("input[name='finalize']").val('1');
						$('#response-form')[0].submit();
						QuizFactory.form_submitted = true;
					}
				}
			});
		}
    };
	
	QuizFactory.init_tags = function(){
		$('.btn-edit-tag').click(function(){
			var button = $(this).removeClass('icon-edit').addClass('icon btn-progress');
			$.ajax({
				type: 'post',
				dataType: 'json',
				url: $('#url-get-tag-details').text(),
				data: {tagid: button.closest('.tag-item-wrapper').find('input[name="tagid"]').val()},
				success: function(data, status, xhr, form){
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').find('.modal-body').html(data.error);
						$('#message-modal').modal('show');
					}else{
						$('#edit-tag-modal').find('input[name="tagid"]').val(data.tag.id);
						$('#edit-tag-modal').find('input[name="name"]').val(data.tag.tag_text);
						$('#edit-tag-modal').find('input[name="alias"]').val(data.tag.alias);
						$('#edit-tag-modal').find('textarea[name="description"]').val(data.tag.description);
						
						$('.btn-submit').off().click(function(){
							var submit = $(this).button('loading');
							$.ajax({
								type: 'post',
								dataType: 'json',
								url: $('.tag-form').attr('action'),
								data: $('.tag-form').serialize(),
								success: function(data, status, xhr, form){
									submit.button('reset');
									if(typeof data.error != 'undefined' && data.error.length > 0){
										$('#edit-tag-modal').find('.error-desc').html(data.error).parent().show();
									}else{
										button.closest('div').find('.tag-desc').html($('.tag-form').find('textarea[name="description"]').val());
										button.closest('div').find('.tag-item').html($('.tag-form').find('input[name="name"]').val());
										$('#edit-tag-modal').modal('hide');
									}
								}
							});
						});
						
						$('#edit-tag-modal').modal('show');
					}
					
					button.removeClass('btn-progress').addClass('icon-edit');
				}
			});
		});
		
		$('.btn-delete-tag').click(function(){
			var button = $(this);
			$('#confirm-modal').modal('show').find('.btn-confirm').off().click(function(){
				var me = $(this).button('reset');
				me.button('loading');
				$.ajax({
					url: $('#url-delete-tag').text(),
					data: {tagid: button.closest('.tag-item-wrapper').find('input[name="tagid"]').val()},
					type: 'post',
					dataType: 'json',
					success: function(data, status, xhr, form){
						if(typeof data.error != 'undefined' && data.error.length > 0){
							$('#message-modal').find('.modal-body').html(data.error);
							$('#message-modal').modal('show');
							me.button('reset');
						}else{
							button.closest('.tag-item-wrapper').css('background-color', '#ccc').find('a').remove();
						}
						$('#confirm-modal').modal('hide');
						me.button('reset');
					}
				});
			});
			return false;
		});
	};
	
	QuizFactory.init_report_responses = function(){
		$('#adminForm').find('.btn-delete-responses').click(function(){
			if($('#adminForm').find('table').find('input[type="checkbox"]:checked').length > 0){
				$('.alert-no-selection').addClass('hide');
				$('#adminForm').attr('action', $('#url_remove_responses').text());
				$('#adminForm').submit();
			} else {
				$('.alert-no-selection').removeClass('hide');
			}
		});
	};
	
	QuizFactory.init_report_oses = function(){
		var data = new Array();
		data.push(['','']);
		var name, value;
		$('.table-oses').find('tbody').find('tr').each(function(){
			columns = $(this).find('td');
			name = columns.eq(1).text();
			try{
				value = parseInt(columns.eq(2).text());
			} catch(e){value = 0;}
			
			data.push([name, value]);
		});
		
		var datatable = google.visualization.arrayToDataTable(data);
		var chart = new google.visualization.PieChart(document.getElementById('chart-wrapper'));
        chart.draw(datatable, {legend: {position: 'none'}, chartArea:{left:20, top:0, width:"100%", height:"100%"}});
	};
	
	QuizFactory.draw_consolidated_charts = function(){
		$('.report-chart').each(function(){
			var data = google.visualization.arrayToDataTable(JSON.parse($(this).find('.array_data').text()));
			var chart = new google.visualization.PieChart(document.getElementById($(this).find('.chart-wrapper').attr('id')));
	        chart.draw(data, {legend: {position: 'none'}, chartArea:{left:20, top:0, width:"100%", height:"100%"}});
		});
	};
})(jQuery);

jQuery(document).ready(function($){
	
	QuizFactory.init_global();
	
	switch($('#cjpageid').val()){
	
		case 'quiz_list':
			QuizFactory.init_quiz_list();
			break;
			
		case 'create_edit_quiz':
			QuizFactory.init_create_edit_quiz();
			break;
			
		case 'quiz_intro':
			QuizFactory.init_quiz_intro();
			break;
			
		case 'quiz_response':
			QuizFactory.init_quiz_response();
			break;
			
		case 'quiz_form':
			QuizFactory.init_form();
			break;
			
		case 'report_responses':
			QuizFactory.init_report_responses();
			break;
			
		case 'tags':
			QuizFactory.init_tags();
			break;
	}
	
//	if(typeof MooTools != 'undefined'){
//		(function($) { 
//			$$('[data-toggle=collapse]').each(function (e) {
//				if(typeof $$(e.get('data-target'))[0] != 'undefined'){
//					$$(e.get('data-target'))[0].hide = null;
//				}
//				if(typeof $$(e.get('data-parent'))[0] != 'undefined'){
//					$$(e.get('data-parent'))[0].hide = null;
//				}
//			});
//		})(MooTools);
//		
//		var mHide = Element.prototype.hide;
//		var mShow = Element.prototype.show;
//		var mSlide = Element.prototype.slide;
//
//		Element.implement({
//		    hide: function () {
//		        if (this.hasClass("collapse")) {
//		            return this;
//		        }
//		        mHide.apply(this, arguments);
//		    },
//		    show: function (v) {
//		        if (this.hasClass("collapse")) {
//		            return this;
//		        }
//		        mShow.apply(this, v);
//		    },
//		    slide: function (v) {
//		        if (this.hasClass("collapse")) {
//		            return this;
//		        }
//		        mSlide.apply(this, v);
//		    }
//		});
//	}
});
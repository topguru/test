var form_submitted = false;
var newqnuniqid = 10000000000;
var SurveyFactory = {};

(function($){
	SurveyFactory.init_global = function(){
		$('body').on('mouseover', '.tooltip-hover', function(){$(this).tooltip('show');});
		$(document.body).append($('<div>', {'id': 'cj-wrapper'}).append($('#cj-wrapper').find('.modal')));
	};
	
	SurveyFactory.init_survey_list = function(){
	};
	
	SurveyFactory.init_create_edit_survey = function(){
		$('.survey-form').validate();
		
		$('.btn-submit-form').click(function(){
			$(this).button('loading');
			$('.survey-form').submit();
		});
	};
	
	SurveyFactory.init_form = function(){
		if(typeof $().chosen != 'undefined'){
			$('#page-id, #move-to-pageid').chosen({ search_contains: true });
		}
		
		SurveyFactory.make_answers_sortable();
		$('.btn-select-user').click(function(){
			$('#user-id-select-model').trigger('click');
		});
		
		$('#qntype-header').click(function(){SurveyFactory.create_new_question(1);});
		$('#qntype-radio').click(function(){SurveyFactory.create_new_question(2);});
		$('#qntype-checkbox').click(function(){SurveyFactory.create_new_question(3);});
		$('#qntype-select').click(function(){SurveyFactory.create_new_question(4);});
		$('#qntype-grid-radio').click(function(){SurveyFactory.create_new_question(5);});
		$('#qntype-grid-checkbox').click(function(){SurveyFactory.create_new_question(6);});
		$('#qntype-singleline').click(function(){SurveyFactory.create_new_question(7);});
		$('#qntype-multiline').click(function(){SurveyFactory.create_new_question(8);});
		$('#qntype-password').click(function(){SurveyFactory.create_new_question(9);});
		$('#qntype-richtext').click(function(){SurveyFactory.create_new_question(10);});
		$('#qntype-image').click(function(){SurveyFactory.create_new_question(11);});
		$('#qntype-images').click(function(){SurveyFactory.create_new_question(12);});
		$('#qntype-name').click(function(){SurveyFactory.create_new_question(13);});
		$('#qntype-email').click(function(){SurveyFactory.create_new_question(14);});
		$('#qntype-calendar').click(function(){SurveyFactory.create_new_question(15);});
		$('#qntype-address').click(function(){SurveyFactory.create_new_question(16);});
		
		$('.btn-rename-page').click(function(){
			var title = $('#page-id').find('option:selected').html();
			title = title.substring(title.indexOf(':') > 0 ? title.indexOf(':') + 2 : 100);
			$('#page-rename-modal').find('input[name="page_title"]').val($.trim(title));
			$('#page-rename-modal').modal('show');
		});
		
		$('.btn-save-page-title').click(function(){
			$(this).button('loading');
			$.ajax({
				url: $('#url_rename_page').text(),
				data: {'pid': $('#page_id').val(), 'title': $('#page-rename-modal').find('input[name="page_title"]').val()},
				type: 'post',
				success: function(data, statusText, xhr, form){
					$('#page-rename-modal').modal('hide');
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').modal('show').find('.modal-body').html(data.error);
					} else {
						$('#page-id, #move-to-pageid').find('option:selected').html($('#page-rename-modal').find('input[name="page_title"]').val());
						$('#page-id, #move-to-pageid').trigger("liszt:updated");
					}
					$('.btn-save-page-title').button('reset');
				}
			});
		});
		
		$('.btn-reorder-page').click(function(){
			$('#reorder-pages-modal').modal('show');
			$('#reorder-pages-modal').find('#page-ordering-list').sortable();
		});
		
		$('.btn-save-page-order').click(function(){
			var ordering = new Array();
			$('#page-ordering-list').find('li').each(function(index){
				ordering.push($(this).attr('id').substring(7));
			});
			$(this).button('loading');
			$.ajax({
				url: $('#url_reorder_pages').text(),
				data: {order: ordering},
				type: 'post',
				dataType: 'json',
				success: function(data, statusText, xhr, form){
					$('#reorder-pages-modal').modal('hide');
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').modal('show').find('.modal-body').html(data.error);
					} else {
						$('body').append($('<select>', {'id': 'dummy_pages'}).append($('#page-id').find('option')));
						$('#move-to-pageid').empty();
						$('#page-id, #move-to-pageid').trigger("liszt:updated");
						$.each(ordering, function(key, order){
							$('#page-id, #move-to-pageid').append($('#dummy_pages').find('option[value="'+order+'"]'));
						});
						$('#page-id, #move-to-pageid').trigger("liszt:updated");
						$('#dummy_pages').remove();
					}
					$('.btn-save-page-order').button('reset');
				}
			});
		});
		
		$('#survey-questions').on('click', '.btn-copy-question', function(){
			var button = $(this);
			var qid = button.closest('.question-item').find('input[name="qid"]').val();
			var qtype = button.closest('.question-item').find('input[name="qtype"]').val();
			try{qid = parseInt(qid);}catch(e){qid = 0;}
			try{qtype = parseInt(qtype);}catch(e){qtype = 1;}
			
			if(qtype > 1){
				SurveyFactory.create_new_question(qtype, qid);
			}
			return false;
		});
		
		$('#survey-questions').on('sortupdate', function(event, ui) {
			if(ui.item.hasClass('question-item')){
				
				var positions = new Array();
				
				$('.survey-form').find('.question-item').each(function(index){
					positions.push((index + 1) + '_' + $(this).find('input[name="qid"]').val());
				});
				
				$.ajax({
					url: $('#url_update_ordering').text(),
					data: {'ordering': positions, 'pid': $('#page_id').val()},
					type: 'post',
					success: function(data, statusText, xhr, form){
						if(typeof data.error != 'undefined' && data.error.length > 0){
							$('#message-modal').modal('show').find('.modal-body').html(data.error);
						}
					}
				});
			}
		});
		
		$('#survey-questions').on('click', '.btn-submit-form', function(){
			var button = $(this);
			var form = button.closest('.question-form');
			var qtype = form.find('input[name="qtype"]').val();
			var answers = new Array();
			var columns = new Array();
			var order = 1;
			var image = '';
			
			form.find('.answers').find('.answer-item').each(function(index){
				answer = $(this).find('.input-answer');
				image = $(this).find('input[name="image-src"]').val();
				if($.trim(answer.val()).length > 0){
					if(answer.attr('name').indexOf('-') == 6){
						id = answer.attr('name').substring(7);
					} else {
						id = 0;
					}
					
					answers.push(id+'_'+order+'_'+answer.val()+'_'+image);
					order++;
				}
			});
			
			if(qtype == 5 || qtype == 6){
				
				order = 1;
				form.find('.columns').find('.answer-item').each(function(index){
					answer = $(this).find('.input-answer');
					if($.trim(answer.val()).length > 0){
						if(answer.attr('name').indexOf('-') == 6){
							id = answer.attr('name').substring(7);
						} else {
							id = 0;
						}
						columns.push(id+'_'+order+'_'+answer.val()+'_');
						order++;
					}
				});				
			}
			
			SurveyFactory.refresh_editor();
			
			form.ajaxSubmit({
				dataType:  'json',
				data: {'pid': $('#page_id').val(), 'answers': answers, 'columns': columns, 'order': $('.question-item').index(form.closest('.question-item')) + 1},
				beforeSubmit: function(arr, objform, options) {
					if(form.valid()){
						button.button('loading');
					} else {
						return false;
					}
				},
				success: function(data){
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').modal('show').find('.modal-body').html(data.error);
					} else {
						var answers = new Array();
						var columns = new Array();
						
						$.each(data.question.answers, function(key, answer){
							if(answer.answer_type == 'x'){
								answers.push(answer);
							}else if(answer.answer_type == 'y'){
								columns.push(answer);
							}
						});

						form.find('select[name="rule-answer"]').empty();
						form.find('.answers').find('.input-answer').each(function(index){
							if(index < answers.length){
								$(this).val(answers[index].answer_label);
								$(this).attr('name', 'answer-'+answers[index].id);		
								form.find('select[name="rule-answer"]').append($('<option>', {'value': answers[index].id}).html(answers[index].answer_label));
							}
						});
						
						if(qtype == 5 || qtype == 6){
							form.find('select[name="rule-column"]').empty();
							form.find('.columns').find('.input-answer').each(function(index){
								if(index < columns.length){
									$(this).val(columns[index].answer_label);
									$(this).attr('name', 'answer-'+columns[index].id);
									form.find('select[name="rule-column"]').append($('<option>', {'value': columns[index].id}).html(columns[index].answer_label));
								}
							});
						}
						
						var question_item = button.closest('.question-item');
						form.find('input[name="title"]').val(data.question.title);
						question_item.find('.qn-title').html(data.question.title);
						question_item.find('#rules-qid').attr('id', 'rules-'+data.question.id);
						
						if(form.find('input[name="qid"]').val() != 0){
							button.closest('.collapse').collapse('toggle');
						}else{
							form.find('input[name="qid"]').val(data.question.id);
							question_item.find('[href$="-qid"]').each(function(){
								var value = $(this).attr('href');
								value = value.substring(0, value.indexOf('-')+1);
								$(this).attr('href', value+data.question.id);
							});
							question_item.find('[id$="-qid"]').each(function(){
								var value = $(this).attr('id');
								value = value.substring(0, value.indexOf('-')+1);
								$(this).attr('id', value+data.question.id);
							});
							question_item.find('[name$="-qid"]').each(function(){
								var value = $(this).attr('name');
								value = value.substring(0, value.indexOf('-')+1);
								$(this).attr('name', value+data.question.id);
							});
							question_item.find('[id$="-qid0"]').each(function(){
								var value = $(this).attr('id');
								value = value.substring(0, value.indexOf('-')+1);
								$(this).attr('id', value+data.question.id);
							});
							form.find('textarea[name="description"]').each(function(){
								$(this).attr('id', 'desc-'+data.question.id);
							});
							SurveyFactory.attach_editor(form.find('#desc-'+data.question.id));
							question_item.find('.accordion-toggle').click();
						}
						
					}
					button.button('reset');
				}
			});
		});
		
		// file upload button function
		var upload_button = null;
		$('#survey-questions').on('click', '.btn-change-image', function(){
			upload_button = $(this);
			$('.input-file-upload').click();
        });
		
		$('.input-file-upload').change(function(){
			button = upload_button;
			button.find('i').addClass('btn-progress').removeClass('fa fa-picture');
			$('.file-upload-error').hide().find('.error-msg').html('');
			
			$('#file-upload-form').ajaxSubmit({
				dataType : 'json',
				success: function(data, status, xhr, $form) {
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('.file-upload-error').show().find('.error-msg').html(data.error);
					}else{
						button.closest('.img-answer-wrapper').find('.img-answer').attr('src', data.url);
						button.closest('.img-answer-wrapper').find('input[name="image-src"]').val(data.file_name);
					}
					button.find('i:first').addClass('fa fa-picture').removeClass('btn-progress');
				}
			});
		});
		// file upload button function
		
		$('#survey-questions').on('click', '.btn-delete-question', function(){
			var button = $(this);
			var qid = button.closest('.question-item').find('input[name="qid"]').val();
			button.addClass('btn-progress').find('i').removeClass('fa fa-trash');
			try{qid = parseInt(qid);}catch(e){}
			
			$('#confirm-modal').modal('show').find('.btn-confirm').off().click(function(){
				if(qid > 0){
					var me = $(this).button('reset');
					me.button('loading');
					$.ajax({
						url: $('#url_delete_qn').text(),
						type: 'post',
						dataType: 'json',
						data: {'pid': $('#page_id').val(), 'qid': qid},
						success: function(data, status, xhr, form){
							if(typeof data.error != 'undefined' && data.error.length > 0){
								$('#message-modal').find('.modal-body').html(data.error);
								$('#message-modal').modal('show');
								$('#confirm-modal').modal('hide');
							} else {
								button.closest('.question-item').hide('slow', function(){ $(this).remove(); });
							}
							me.button('reset');
							button.removeClass('btn-progress').find('i').addClass('fa fa-trash');
							$('#confirm-modal').modal('hide');
						}
					});
				} else {
					button.closest('.question-item').hide('slow', function(){ $(this).remove(); });
					$('#confirm-modal').modal('hide');
				}
			});
			$('#confirm-modal').modal('show').find('.btn-cancel').off().click(function(){
				button.removeClass('btn-progress').find('i').addClass('fa fa-trash');
			});
			return false;
		});
		
		$('#survey-questions').on('click', '.btn-move-question', function(){
			var button = $(this);
			$('#page-modal').modal('show');
			$('.btn-save-pid').off().click(function(){
				var me = $(this);
				me.button('loading');
				$.ajax({
					type: 'get',
					dataType: 'json',
					url: $('#url_move_page').text(),
					data: {'qid': button.closest('.question-item').find('input[name="qid"]').val(), 'pid': $('#page-modal').find('select[name="pid"]').val()},
					success: function(data, status, xhr, form){
						$('#page-modal').modal('hide');
						if(typeof data.error != 'undefined' && data.error.length > 0){
							$('#message-modal').find('.modal-body').html(data.error);
							$('#message-modal').modal('show');
						}else{
							button.closest('.question-item').remove();
							me.button('reset');
						}
					}
				});
			});
			return false;
		});
		
		$('#survey-questions').on('click', '.btn-add-answer', function(){
			var template = $('<div>', {'class': 'margin-bottom-10 form-inline answer-item clearfix'}).html($('#tpl-new-answer').html());
			var type = $(this).closest('.question-item').find('input[name="qtype"]').val();
			try{type = parseInt(type);}catch(e){type = 2;}
			
			if(type == 11 || type == 12){
				template.find('.input-answer-2').remove();
			} else {
				template.find('.img-answer-wrapper').remove();
			}
			template.insertBefore($(this));
			
			if(type == 3 || type == 13){
				var select = $(this).closest('.question-item').find('select[name="min_selections"]');
				select.append($('<option>', {'value': select.find('option').length}).html(select.find('option').length));
				
				var select = $(this).closest('.question-item').find('select[name="max_selections"]');
				select.append($('<option>', {'value': select.find('option').length}).html(select.find('option').length));
			}
		});
		
		$('#survey-questions').on('click', '.btn-add-column', function(){
			var template = $('<div>', {'class': 'margin-bottom-10 form-inline answer-item'}).html($('#tpl-new-answer').html());
			template.find('.correct-answer-select, .img-answer-wrapper').remove();
			template.insertBefore($(this));
		});
		
		$('#survey-questions').on('click', '.btn-delete-answer', function(){
			var question_item = $(this).closest('.question-item');
			var type = question_item.find('input[name="qtype"]').val();
			try{type = parseInt(type);}catch(e){type = 2;}
			$(this).closest('.answer-item').remove();
			
			if(type == 3 || type == 13){
				question_item.find('select[name="min_selections"]').children('option:not(:first)').remove();
				question_item.find('select[name="max_selections"]').children('option:not(:first)').remove();
				var count = question_item.find('.answers').find('.answer-item').length;
				
				for(var i=1; i<=count; i++){
					question_item.find('select[name="min_selections"]').append($('<option>', {value: i}).html(i));
					question_item.find('select[name="max_selections"]').append($('<option>', {value: i}).html(i));
				}
			}
		});
		
		$('#btn-remove-page').click(function(e){
			e.preventDefault();
			$('#remove-page-modal').modal('show').find('.btn-confirm').attr('href', $(this).attr('href')).click(function(){$(this).button('loading');});
		});
		
		$('#survey-questions').on('click', 'input[name="rule-name"]', function(){
			if($(this).val() == 1 || $(this).val() == 2){
				$(this).closest('.conditional-rules-form').find('.rule-answer, .rule-column').hide();
			} else {
				$(this).closest('.conditional-rules-form').find('.rule-answer, .rule-column').show();
			}
			$(this).closest('.conditional-rules-form').find('.rule-criteria').insertAfter($(this).parent()).slideDown();
		});
		
		$('#survey-questions').on('click', '.btn-save-rule', function(){
			var button = $(this);
			var form = button.closest('.conditional-rules-form');
			var rule = new Object();
			
			rule.qid = form.closest('.question-form').find('input[name="qid"]').val();
			rule.type = form.find('input[name="rule-name"]:checked').val();
			rule.answer = form.find('select[name="rule-answer"]').val();
			rule.column = form.find('select[name="rule-column"]').val();
			rule.outcome = form.find('input[name="rule-outcome"]:checked').val();
			rule.page = form.find('select[name="rule-page"]').val();
			
			$.ajax({
				url: $('#url_save_rule').text(),
				dataType: 'json',
				type: 'post',
				data: {'rule': rule},
				beforeSend: function(xhr, settings){
					if(!form.find('input[name="rule-name"]').is(':checked') || !form.find('input[name="rule-outcome"]').is(':checked')) {
						form.find('.invalid-form-alert').show();
						return false;
					} else {
						button.button('loading');
						form.find('.invalid-form-alert').hide();
					}
				},
				success: function(data, status, xhr, form){
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').find('.modal-body').html(data.error);
						$('#message-modal').modal('show');
					}else{
						var tbody = button.closest('.rules-wrapper').find('.rules-list').find('tbody').empty();
						$.each(data.rules, function(index, rule){
							tbody.append(
								$('<tr>').append(
									$('<td>').html(rule.rule),
									$('<td>').append(
										$('<a>', {'class': 'btn-remove-rule', 'href': '#', 'onclick': 'return false;'}).append($('<i>', {'class': 'fa fa-trash'})),
										$('<input>', {'type': 'hidden', 'name': 'rule_id'}).val(rule.id)
									)
								)
							);
						});
						button.button('reset');
					}
				}
			});
		});
		
		$('#survey-questions').on('click', '.btn-remove-rule', function(){
			var button = $(this);
			var qid = button.closest('.question-form').find('input[name="qid"]').val();
			var rule_id = button.parent().find('input[name="rule_id"]').val();
			button.find('i').remove();
			button.append($('<span>', {'class': 'btn-progress'})).removeClass('btn-remove-rule');
			
			$.ajax({
				url: $('#url_remove_rule').text(),
				dataType: 'json',
				data: {'qid': qid, 'rid': rule_id},
				success: function(data, status, xhr, form){
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').find('.modal-body').html(data.error);
						$('#message-modal').modal('show');
					}else{
						button.closest('tr').remove();
					}
				}
			});
		});
	};
	
	SurveyFactory.make_answers_sortable = function(){
		if($('#survey-questions').find('.answers').length > 0){
			$('#survey-questions').find('.answers, .columns').sortable({revert: true, handle: '.btn-sort-answer', placeholder: 'well well-small', forcePlaceholderSize: true});
		}
		if($('#survey-questions').find('.columns').length > 0){
			$('#survey-questions').find('.columns').sortable({revert: true, handle: '.btn-sort-answer', placeholder: 'well well-small', forcePlaceholderSize: true});
		}
		$('#survey-questions').sortable({revert: true, handle: '.qn-btn-drag', placeholder: 'well well-small', forcePlaceholderSize: true});
	};
	
	SurveyFactory.create_new_question = function(type, copy){
		
		copy = copy || false;		
		if(copy && jQuery('#qn-'+copy).length > 0){
			var desc = $('#qn-'+copy).find('textarea[name="description"]');
			SurveyFactory.detach_editor(desc);
			
			var question_item = $('#qn-'+copy).closest('.question-item').clone();
			question_item.find('input[name="qid"]').val(0);
			question_item.find('#rules-'+copy).attr('id', 'rules-qid');
			question_item.find('.input-answer').attr('name', 'answer-aid');
			question_item.find('.rules-list').find('tbody').empty();
			
			question_item.find('[href$="-'+copy+'"]').each(function(){
				var value = $(this).attr('href');
				value = value.substring(0, value.indexOf('-')+1);
				$(this).attr('href', value+'qid');
			});
			question_item.find('[id$="-'+copy+'"]').each(function(){
				var value = $(this).attr('id');
				value = value.substring(0, value.indexOf('-')+1);
				$(this).attr('id', value+'qid');
			});
			question_item.find('[name$="-'+copy+'"]').each(function(){
				var value = $(this).attr('name');
				value = value.substring(0, value.indexOf('-')+1);
				$(this).attr('name', value+'qid');
			});
			question_item.find('[id$="-'+copy+'"]').each(function(){
				var value = $(this).attr('id');
				value = value.substring(0, value.indexOf('-')+1);
				$(this).attr('id', value+'qid0');
			});
			$('.survey-form').append(question_item);
			
			SurveyFactory.attach_editor($('#qn-'+copy).find('textarea[name="description"]'));
			question_item.find('.btn-submit-form').click();
		} else {
			var template = $('<div>', {'class': 'accordion-group question-item'}).html($('#tpl-question').html());
			if(type == 1){
				template.find('.blk-explanation, .blk-options, .btn-copy-question').remove();
				template.find('.btn-sort-answer').attr('title', '').removeClass('btn-sort-answer').find('.fa fa-move').removeClass('fa fa-move').addClass('fa fa-screenshot');
			} else {
				template.find('.tab-content').append($('#tpl-rules-tab').html());
			}
			
			if(type != 2 && type != 3 && type != 4 && type != 5 && type != 6 && type != 11 && type != 12){
				template.find('.blk-explanation, .answers, #answers-qid').remove();
				template.find('.nav-tabs').find('a[href="#answers-qid"]').closest('li').remove();
				template.find('input[name="rule-name"][value="3"]').closest('label').remove();
				template.find('input[name="rule-name"][value="4"]').closest('label').remove();
			}
			
			if(type != 2 && type != 3 && type != 4 && type != 5 && type != 6){
				template.find('.blk-custom-answer').remove();
			}
			
			if(type != 2 && type != 3 && type != 11 && type != 12){
				template.find('.blk-orientation').remove();
			}
			
			if(type != 5 && type != 6){
				template.find('.columns, .rule-column').remove();
			}
			if(type == 11 || type == 12){
				template.find('.input-answer-2').remove();
			} else {
				template.find('.img-answer-wrapper').remove();
			}
			
			if(type != 3 && type != 13){
				template.find('.blk-selection-range').remove();
			}
			
			switch (type) {
			case 1:
				template.find('.icon').addClass('fa fa-magnet');
				break;
			case 2:
				template.find('.icon').addClass('fa fa-dot-circle-o');
				break;
			case 3: 
				template.find('.icon').addClass('fa fa-check');
				break;
			case 4:
				template.find('.icon').addClass('fa fa-chevron-down');
				break;
			case 5:
				template.find('.icon').addClass('fa fa-th-large');
				break;
			case 6: 
				template.find('.icon').addClass('fa fa-th-large');
				break;
			case 7:
				template.find('.icon').addClass('fa fa-minus');
				break;
			case 8:
				template.find('.icon').addClass('fa fa-align-justify');
				break;
			case 9:
				template.find('.icon').addClass('fa fa-qrcode');
				break;
			case 10:
				template.find('.icon').addClass('fa fa-file');
				break;
			case 11:
				template.find('.icon').addClass('fa fa-picture-o');
				break;
			case 12:
				template.find('.icon').addClass('fa fa-film');
				break;
			case 13:
				template.find('.icon').addClass('fa fa-user');
				break;
			case 14:
				template.find('.icon').addClass('fa fa-envelope-o');
				break;
			case 15:
				template.find('.icon').addClass('fa fa-calendar');
				break;
			case 16:
				template.find('.icon').addClass('fa fa-building-o');
				break;
			}
			template.find('input[name="qtype"]').val(type);			
			if(type == 1){
				$('.survey-form').prepend(template);
			} else {
				$('.survey-form').append(template);
			}
			template.find('.btn-submit-form').click();		
		}		
	};
	
	SurveyFactory.attach_editor = function(target){
		if(typeof cjbbcode != 'undefined'){
			target.markItUp(cjbbcode);
//		}else if(typeof WFEditor != 'undefined'){
//			WFEditor.create([target.attr('id')]);
		}else if(typeof tinymce != 'undefined'){
			tinymce.EditorManager.execCommand('mceAddControl',true, target.attr('id'));
//			tinyMCE.execCommand('mceAddControl', false, target.attr('id'));
		}
	};
	
	SurveyFactory.detach_editor = function(target){
		if(typeof cjbbcode != 'undefined'){
			target.markItUpRemove();
//		}else if(typeof WFEditor != 'undefined'){
//			WFEditor.create([target.attr('id')]);
		}else if(typeof tinymce != 'undefined'){
			tinymce.EditorManager.execCommand('mceRemoveControl',true, target.attr('id'));
//			tinyMCE.execCommand('mceAddControl', false, target.attr('id'));
		}
	};

	SurveyFactory.refresh_editor = function(){
        if(typeof tinymce != 'undefined'){
        	tinymce.triggerSave(true, true);
//        	tinymce.EditorManager.execCommand('mceRepaint');
        }
	};
	
	SurveyFactory.init_survey_response = function(){		
    	$('#btn_submit').click(function(){
    		if(form_submitted == false){
        		if($('#response-form').valid()){
            		$('#txt_errors_alert').hide();
            		$('#response-form').submit();
            		$(this).button('loading');
            		form_submitted = true;
        		} else {
        			$('#txt_errors_alert').show();
        			return false;
        		}    			
    		}
    	});
		
		$('#btn-previous').click(function(){
			if(form_submitted == false){
        		if($('#response-form').valid()){
            		$('#txt_errors_alert').hide();
            		$('#response-form').attr('action', $('#url_previous_page').text());
            		$('#response-form').submit();
            		$(this).button('loading');
            		form_submitted = true;
        		} else {
        			$('#txt_errors_alert').show();
        			return false;
        		}    			
			}
		});
		
		$.validator.addMethod('minselect', function(value, element, params){
			var min_selections = params[0];
			try{min_selections = parseInt(min_selections);}catch(e){min_selections = 0;}
			return $('input[name="'+element.name+'"][type="checkbox"]:checked').length >= min_selections;
		}, $.validator.format($('#msg_validation_min_answers_required').text()));
		
		$.validator.addMethod('maxselect', function(value, element, params) {
			var max_selections = params[0];
			try{max_selections = parseInt(max_selections);}catch(e){max_selections = 0;}
			return $('input[name="'+element.name+'"][type="checkbox"]:checked').length <= max_selections;
		}, $.validator.format($('#msg_validation_max_answers_required').text()));
    	
		$('#response-form').validate({
			errorPlacement: function(error, element) {
				error.html($('#default_error_required').html());
				if(element.closest('.question-item').find('label.error').length == 0){
					error.insertAfter( element.closest('.question-item').find('.question-title') );
				}
			}
		});
	};
	
	SurveyFactory.init_report_responses = function(){
		$('#adminForm').find('.btn-delete-responses').click(function(){
			if($('#adminForm').find('table').find('input[type="checkbox"]:checked').length > 0){
				$('.alert-no-selection').addClass('hide');
				$('#adminForm').find('input[name=task]').val('remove_responses');
				$('#adminForm').submit();
			} else {
				$('.alert-no-selection').removeClass('hide');
			}
		});
		
		$('#adminForm').find('.btn-pdf-download').click(function(){
			if($('#adminForm').find('table').find('input[type="checkbox"]:checked').length > 0){
				$('#adminForm').find('input[name=task]').val('pdfdownload');
				$('#adminForm').submit();
			} else {
				$('.alert-no-selection').removeClass('hide');
			}
		});
	};
	
	SurveyFactory.init_report_oses = function(){
		var data = new Array();
		data.push(['','']);
		var name, value;
		$('.table-oses').find('tbody').find('tr').each(function(){
			columns = $(this).find('td');
			name = columns.eq(1).text();
			try{
				value = parseInt(columns.eq(2).text());
			} catch(e){value = 0;}
			
			data.push([name, value]);
		});
		
		var datatable = google.visualization.arrayToDataTable(data);
		var chart = new google.visualization.PieChart(document.getElementById('chart-wrapper'));
        chart.draw(datatable, {legend: {position: 'none'}, chartArea:{left:20, top:0, width:"100%", height:"100%"}});
	};
	
	SurveyFactory.draw_consolidated_charts = function(){
		$('.report-chart').each(function(){
			var data = google.visualization.arrayToDataTable(JSON.parse($(this).find('.array_data').text()));
			var chart = new google.visualization.PieChart(document.getElementById($(this).find('.chart-wrapper').attr('id')));
	        chart.draw(data, {
	        	legend: {position: 'none'}, 
	        	chartArea:{left:20, top:0, width:"100%", height:"100%"}, 
	        	colors: JSON.parse($(this).find('.array_data_colors').text())
	        });
		});
	};
	
	SurveyFactory.init_invite_users = function(){
		/*////////////////// manual invitation //////////////////////*/
		$('.btn-create-urls').click(function(){
			var num_urls = $('input[name="num-survey-urls"]').val();			
			try{num_urls = parseInt(num_urls);}catch(e){num_urls = 0;}
			if(num_urls == 0) return false;
			var button = $(this).button('loading');
			$.ajax({
				url: $('#url_create_unique_urls').text(),
				dataType: 'json',
				data: {'num_urls': num_urls},
				success: function(data, status, xhr, form){
					button.button('reset');
					SurveyFactory.load_unique_urls_list($('.table-urls-list'), 0);
				}
			});
		});
		
		$('.invite-manual-wrapper').on('click', '.btn-pager-urls-previous, .btn-pager-urls-next', function(){
			var current_page = $('.invite-manual-wrapper').find('input[name="urls-current-page"]').val();
			try{current_page = parseInt(current_page);}catch(e){}
			if(current_page == 0 && $(this).hasClass('btn-pager-urls-previous')) return false;
			$(this).addClass('btn-progress');
			
			var next = $(this).hasClass('btn-pager-urls-previous') ? current_page - 1 : current_page + 1;
			next = next >= 0 ? next : 0;
			
			SurveyFactory.load_unique_urls_list($('.table-urls-list'), next);
		});
		/*////////////////// manual invitation //////////////////////*/
		
		/*//////////////////// contact groups ///////////////////////*/
		$('.btn-create-contact-group').click(function(){
			$('#group-form-modal').modal('show');
			$('.alert-delete-group-error').hide();
		});
		$('.btn-save-contact-group').click(function(){
			var button = $(this);
			var group_name = $('#group-form-modal').find('input[name="group-name"]').val();
			var group_id = $('#group-form-modal').find('input[name="group-id"]').val();
			button.button('loading');
			$.ajax({
				url: $('#url-save-contact-group').text(),
				dataType: 'json',
				type: 'post',
				data: {'group-name': group_name, 'group-id': group_id},
				success: function(data, status, xhr, form){
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').find('.modal-body').html(data.error);
						$('#message-modal').modal('show');
					} else {
						$('.contact-groups-list').append(
							$('<label>', {'class': 'radio'}).append(
								$('<input>', {'type': 'radio', 'name': 'group_id', 'value': data.group.id}),
								$('<span>').html(data.group.name + ' - '),
								$('<a>', {'class': 'btn-edit-contact-assignments','href': '#', 'onclick': 'return false;'}).html($('#txt_assign_contacts').text())
							)
						);
						$('select[name="filter-group-id"]').append($('<option>',{'value': data.group.id}).html(data.group.name));
						$('#assign-contacts-modal').find('select[name="group-id"]').append($('<option>',{'value': data.group.id}).html(data.group.name));
						$('.btn-invite-contact-group').removeClass('disable');
					}
					$('#group-form-modal').modal('hide');
					button.button('reset');
				}
			});
		});
		
		$('.btn-delete-contact-group').click(function(){
			var button = $(this);
			var group_id = $('.contact-groups-list').find('input[name="group_id"]:checked').val();
			try{group_id = parseInt(group_id);}catch(e){}
			
			if(group_id > 0){
				$('.alert-delete-group-error').hide();
			} else {
				$('.alert-delete-group-error').show();
				return false;
			}
			
			button.find('i').addClass('btn-progress').removeClass('fa fa-trash');
			
			$('#confirm-modal').modal('show').find('.btn-confirm').off().click(function(){
				var me = $(this).button('reset');
				me.button('loading');
				$.ajax({
					url: $('#url_delete_contact_group').text(),
					type: 'post',
					dataType: 'json',
					data: {'gid': group_id},
					success: function(data, status, xhr, form){
						if(typeof data.error != 'undefined' && data.error.length > 0){
							$('#message-modal').find('.modal-body').html(data.error);
							$('#message-modal').modal('show');
						} else {
							$('.contact-groups-list').find('input[name="group_id"][value="'+group_id+'"]').parent().remove();
							$('select[name="filter-group-id"]').find('option[value="'+group_id+'"]').remove();
							$('#assign-contacts-modal').find('select[name="group-id"]').find('option[value="'+group_id+'"]').remove();
						}
						me.button('reset');
						button.find('i').addClass('fa fa-trash').removeClass('btn-progress');
						$('#confirm-modal').modal('hide');
					}
				});
			});
			
			$('#confirm-modal').modal('show').find('.btn-cancel').off().click(function(){
				button.find('i').addClass('fa fa-trash').removeClass('btn-progress');
			});
			
			return false;
		});
		
		$('.chk-global-select-contacts').click(function(){
			var checked = $(this).is(':checked');
			$(this).closest('table').find('input[type="checkbox"]').attr('checked', checked);
		});
		
		$('#add-contacts-modal').find('.btn-save-contacts').click(function(){
			var contacts = new Array();
			var button = $(this).button('loading');
			$('#add-contacts-modal').find('tbody').find('tr').each(function(){
				var contact = new Object();
				contact.name = $(this).find('input[name="contact-name"]').val();
				contact.email = $(this).find('input[name="contact-email"]').val();
				
				if($.trim(contact.name) != '' && $.trim(contact.email) != ''){
					contacts.push(contact);
				}
			});
			
			if(contacts.length > 0){
				$.ajax({
					url: $('#url_save_contacts').text(),
					dataType: 'json',
					type: 'post',
					data: {'contacts': contacts},
					success: function(data, status, xhr, form){
						$('#message-modal').find('.modal-body').html(data.message);
						$('#message-modal').modal('show');
						$('#add-contacts-modal').find('input').val('');
						$('#add-contacts-modal').modal('hide');
						button.button('reset');
						SurveyFactory.load_contacts_list($('.contacts-list'), 0);
					}
				});
			}
		});
		
		$('.btn-add-contacts').click(function(){
			$('#add-contacts-modal').modal('show');
		});
		
		$('.btn-delete-contacts').click(function(){
			var button = $(this);
			if($('.contacts-list').find('input[name="cid[]"]:checked').length > 0){
				$('.alert-delete-contacts-error').hide();
			} else {
				$('.alert-delete-contacts-error').show();
				return false;
			}
			button.button('loading');
			cids = new Array();
			$('.contacts-list').find('input[name="cid[]"]:checked').each(function(index, checkbox){
				cids.push($(this).val());
			});
			
			$.ajax({
				url: $('#url_delete_contacts').text(),
				type: 'post',
				dataType: 'json',
				data: {'cid': cids},
				success: function(data, status, xhr, form){
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').find('.modal-body').html(data.error);
						$('#message-modal').modal('show');
						$('#confirm-modal').modal('hide');
					} else {
						SurveyFactory.load_contacts_list($('.contacts-list'), 0);
					}
					button.button('reset');
				}
			});
		});
		
		$('#tab-contacts').on('click', '.btn-pager-contacts-previous, .btn-pager-contacts-next', function(){
			var current_page = $('#tab-contacts').find('input[name="contacts-current-page"]').val();
			try{current_page = parseInt(current_page);}catch(e){}
			if(current_page == 0 && $(this).hasClass('btn-pager-contacts-previous')) return false;
			$(this).addClass('btn-progress');
			
			var next = $(this).hasClass('btn-pager-contacts-previous') ? current_page - 1 : current_page + 1;
			next = next >= 0 ? next : 0;
			
			SurveyFactory.load_contacts_list($('.contacts-list'), next);
		});
		
		$('.btn-search-contacts').click(function(){
			SurveyFactory.load_contacts_list($('.contacts-list'), 0);
		});
		
		$('select[name="filter-group-id"], select[name="filter-limit"]').change(function(){
			SurveyFactory.load_contacts_list($('.contacts-list'), 0);
		});
		
		$('.btn-import-contacts').click(function(){
			$('#file-upload-form').find('input').click();
		});
		
		$('#file-upload-form').find('input').change(function(){
			button = $('.btn-import-contacts');
			button.find('i').addClass('btn-progress').removeClass('fa fa-upload');
			
			$('#file-upload-form').ajaxSubmit({
				dataType : 'json',
				success: function(data, status, xhr, $form) {
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').find('.modal-body').html(data.error);
						$('#message-modal').modal('show');
					}else{
						$('#message-modal').find('.modal-body').html(data.message);
						$('#message-modal').modal('show');
						SurveyFactory.load_contacts_list($('.contacts-list'), 0);
					}
					button.find('i:first').addClass('fa fa-share').removeClass('btn-progress');
				}
			});
		});
		
		$('#invite-contact-groups').on('click', '.btn-edit-contact-assignments', function(){
			$('a[href="#tab-contacts"]').tab('show');
		});
		
		$('.btn-assign-contacts').click(function(){
			if($('.contacts-list').find('input[name="cid[]"]:checked').length > 0){
				$('.alert-delete-contacts-error').hide();
			} else {
				$('.alert-delete-contacts-error').show();
				return false;
			}
			$('#assign-contacts-modal').modal('show');
		});
		
		$('#assign-contacts-modal').find('.btn-assign-contacts').click(function(){
			var button = $(this).button('loading');
			var gid = $('#assign-contacts-modal').find('select[name="group-id"]').find('option:selected').attr('value');
			cids = new Array();
			$('.contacts-list').find('input[name="cid[]"]:checked').each(function(index, checkbox){
				cids.push($(this).val());
			});
			
			$.ajax({
				url: $('#url_assign_contacts').text(),
				type: 'post',
				dataType: 'json',
				data: {'cid': cids, 'gid': gid},
				success: function(data, status, xhr, form){
					button.button('reset');
					$('#tab-contacts').find('input[type="checkbox"]').attr('checked', false);
					$('#assign-contacts-modal').modal('hide');
					
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').find('.modal-body').html(data.error);
						$('#message-modal').modal('show');
					} else {
						$('#message-modal').find('.modal-body').html(data.message);
						$('#message-modal').modal('show');
					}
				}
			});
		});
		
		/*//////////////////////// contact groups ///////////////////////////*/
		
		/*//////////////////// Search registered users ///////////////////////*/
		
		var input = $('input[name="input-username"]');
		input.keyup(function(e){
			if(input.val().length > 0 && 
					(e.which == 32 || 
					(e.which >= 48 && e.which <= 57) || 
					(e.which >= 97 && e.which <= 122) || 
					(e.which >= 65 && e.which <= 90))){
				$.ajax({
					url: $('#url_search_users').text(),
					data: {'search': input.val()},
					dataType: 'json',
					success: function(data, statusText, xhr, form){
						if(typeof data.error != 'undefined' && data.error.length > 0){
							$('#message-modal').find('.modal-body').html(data.error);
							$('#message-modal').modal('show');
						} else if(data.data != null){
							$('#source_names').find('option').remove();
							$.each(data.data, function(index, user){
								$('#source_names').append($('<option>', {value: user.id}).html(user.username+' ('+user.name+')'));
							});
						}
					}
				});
			}
		});
		
		$('.to_right').click(function(){$('#source_names option:selected').appendTo($('#target_names'));});
		$('.to_left').click(function(){$('#target_names option:selected').appendTo($('#source_names'));});
		$('.all_right').click(function(){$('#source_names option').appendTo($('#target_names'));});
		$('.all_left').click(function(){$('#target_names option').appendTo($('#source_names'));});
		
		/*//////////////////// Search registered users ///////////////////////*/
		
		/*////////////////////// Send invitations ///////////////////////////*/
		
		$('.btn-invite-contact-group').click(function(){
			var button = $(this);
			var group_id = $('.contact-groups-list').find('input[name="group_id"]:checked').val();
			try{group_id = parseInt(group_id);}catch(e){}
			
			if(group_id > 0){
				$('.alert-delete-group-error').hide();
			} else {
				$('.alert-delete-group-error').show();
				return false;
			}
			
			button.find('i').addClass('btn-progress').removeClass('fa fa-trash');
			SurveyFactory.refresh_editor();
			
			$.ajax({
				url: $('#url_invite_contact_group').text(),
				dataType: 'json',
				type: 'post',
				data: {'gid': group_id, 'invitation-subject': $('input[name="invitation-subject"]').val(), 'invitation-body': $('#invitation-body').val()},
				success: function(data, status, xhr, form){
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').find('.modal-body').html(data.error);
						$('#message-modal').modal('show');
					} else {
						if(data.remaining > 0){
							button.after(data.message);
						} else {
							$('#message-modal').find('.modal-body').html(data.message);
							$('#message-modal').modal('show');
						}
					}
					button.find('i').removeClass('btn-progress').addClass('fa fa-trash');
				}
			});
		});
		
		$('.btn-invite-reg-groups').click(function(){
			var groups = new Array();
			
			$('#invite-registered-groups').find('input[name="group_id[]"]:checked').each(function(){
				groups.push($(this).val());
			});
			
			if(groups.length == 0){
				$('.alert-no-user-group-selected').show();
				return false;
			} else {
				$('.alert-no-user-group-selected').hide();
			}
			
			var button = $(this).button('loading');
			SurveyFactory.refresh_editor();
			
			$.ajax({
				url: $('#url_invite_registered_groups').text(),
				dataType: 'json',
				type: 'post',
				data: {'gid[]': groups, 'invitation-subject': $('input[name="invitation-subject"]').val(), 'invitation-body': $('#invitation-body').val()},
				success: function(data, status, xhr, form){
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').find('.modal-body').html(data.error);
						$('#message-modal').modal('show');
					} else {
						$('#message-modal').find('.modal-body').html(data.message);
						$('#message-modal').modal('show');
					}
					button.button('reset');
				}
			});
		});
		
		$('.btn-invite-js-groups').click(function(){
			var groups = new Array();
			
			$('#invite-jomsocial-groups').find('input[name="gid[]"]:checked').each(function(){
				groups.push($(this).val());
			});
			
			if(groups.length == 0){
				$('.alert-no-user-group-selected').show();
				return false;
			} else {
				$('.alert-no-user-group-selected').hide();
			}
			
			var button = $(this).button('loading');
			SurveyFactory.refresh_editor();
			
			$.ajax({
				url: $('#url_invite_js_groups').text(),
				dataType: 'json',
				type: 'post',
				data: {'gid[]': groups, 'invitation-subject': $('input[name="invitation-subject"]').val(), 'invitation-body': $('#invitation-body').val()},
				success: function(data, status, xhr, form){
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').find('.modal-body').html(data.error);
						$('#message-modal').modal('show');
					} else {
						$('#message-modal').find('.modal-body').html(data.message);
						$('#message-modal').modal('show');
					}
					button.button('reset');
				}
			});
		});
		
		$('.btn-invite-registered-users').click(function(){
			if($('#target_names option').length == 0){
				$('.alert-no-user-selected').show();
				return false;
			} else {
				$('.alert-no-user-selected').hide();
			}
			
			var userids = new Array;
			$('#target_names option').each(function(){
				userids.push($(this).val());
			});
			
			var button = $(this).button('loading');
			$.ajax({
				url: $('#url_invite_registered_users').text(),
				dataType: 'json',
				type: 'post',
				data: {'cid[]': userids, 'invitation-subject': $('input[name="invitation-subject"]').val(), 'invitation-body': $('#invitation-body').val()},
				beforeSend: function(xhr, settings){
					SurveyFactory.refresh_editor();
				},
				success: function(data, statusText, xhr, form){
					if(typeof data.error != 'undefined' && data.error.length > 0){
						$('#message-modal').find('.modal-body').html(data.error);
						$('#message-modal').modal('show');
					} else {
						$('#message-modal').find('.modal-body').html(data.message);
						$('#message-modal').modal('show');
					}
					button.button('reset');
				}
			});
		});
		
		/*////////////////////// Send invitations ///////////////////////////*/
	};
	
	SurveyFactory.load_unique_urls_list = function(table, page){
		var limit = $.trim($('.invite-manual-wrapper').find('select[name="filter-limit"]').find('option:selected').attr('value'));
		limit = limit > 0 ? limit : 20;
		var response_status = null;
		$.ajax({
			url: $('#url_get_urls_list').text(),
			dataType: 'json',
			type: 'post',
			data: {'pid': page, 'limit': limit},
			success: function(data, status, xhr, form){
				if(typeof data.error != 'undefined' && data.error.length > 0){
					$('#message-modal').find('.modal-body').html(data.error);
					$('#message-modal').modal('show');
					table.find('tbody').empty();
				} else {
					var tbody = table.find('tbody').empty();
					var base_num = page * limit;
					$.each(data.urls, function(index, url){
						response_status = url.response_status == 1 ? '<i class="fa fa-ok-circle">' : '<i class="fa fa-filter">';
						tbody.append(
							$('<tr>').append(
								$('<td>').append(base_num + index + 1),
								$('<td>').append(url.url),
								$('<td>').append(url.created),
								$('<td>').append(response_status)
							)
						);
					});
					if(page == 0){
						$('.invite-manual-wrapper').find('.pager').find('.previous').addClass('disabled');
					} else {
						$('.invite-manual-wrapper').find('.pager').find('.previous').removeClass('disabled');
					}
					
					if(data.urls.length != limit){
						$('.invite-manual-wrapper').find('.pager').find('.next').addClass('disabled');
					} else {
						$('.invite-manual-wrapper').find('.pager').find('.next').removeClass('disabled');
					}
				}
				$('.invite-manual-wrapper').find('input[name="urls-current-page"]').val(page);
				$('.invite-manual-wrapper').find('.pager').find('.btn-progress').removeClass('btn-progress');
			}
		});
		return true;
	};
	
	SurveyFactory.load_contacts_list = function(table, page){
		var search = $.trim($('#tab-contacts').find('input[name="input-search-contacts"]').val());
		var group_id = $.trim($('#tab-contacts').find('select[name="filter-group-id"]').find('option:selected').attr('value'));
		var limit = $.trim($('#tab-contacts').find('select[name="filter-limit"]').find('option:selected').attr('value'));
		try{limit = parseInt(limit);}catch(e){limit = 20;}
		$.ajax({
			url: $('#url_get_contacts').text(),
			dataType: 'json',
			type: 'post',
			data: {'pid': page, 'search': search, 'gid': group_id, 'limit': limit},
			success: function(data, status, xhr, form){
				if(typeof data.error != 'undefined' && data.error.length > 0){
					$('#message-modal').find('.modal-body').html(data.error);
					$('#message-modal').modal('show');
					table.find('tbody').empty();
				} else {
					var tbody = table.find('tbody').empty();
					var base_num = page * limit;
					$.each(data.contacts, function(index, contact){
						tbody.append(
							$('<tr>').append(
								$('<td>').append(base_num + index + 1),
								$('<td>').append($('<input>', {'name': 'cid[]', 'type': 'checkbox', 'value': contact.id})),
								$('<td>').append(contact.name),
								$('<td>').append(contact.email)
							)
						);
					});
					if(page == 0){
						$('#tab-contacts').find('.pager').find('.previous').addClass('disabled');
					} else {
						$('#tab-contacts').find('.pager').find('.previous').removeClass('disabled');
					}
					
					if(data.contacts.length != limit){
						$('#tab-contacts').find('.pager').find('.next').addClass('disabled');
					} else {
						$('#tab-contacts').find('.pager').find('.next').removeClass('disabled');
					}
				}
				$('#tab-contacts').find('input[name="contacts-current-page"]').val(page);
				$('#tab-contacts').find('.pager').find('.btn-progress').removeClass('btn-progress');
			}
		});
		return true;
	};
})(jQuery);

jQuery(document).ready(function($){
	
	SurveyFactory.init_global();
	
	switch($('#cjpageid').val()){
	
		case 'survey_list':
			SurveyFactory.init_survey_list();
			break;
			
		case 'create_edit_survey':
			SurveyFactory.init_create_edit_survey();
			break;
			
		case 'survey_intro':
			SurveyFactory.init_survey_intro();
			break;
			
		case 'survey_response':
			SurveyFactory.init_survey_response();
			break;
			
		case 'survey_form':
			SurveyFactory.init_form();
			break;
			
		case 'report_responses':
			SurveyFactory.init_report_responses();
			break;
			
		case 'survey_invite':
			SurveyFactory.init_invite_users();
			break;
	}
});